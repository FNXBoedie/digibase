<!DOCTYPE html>
<html lang="nl-BE">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiBase - Digipunt Assistent</title>
    <style>
        :root {
            --primary-color: #6a11cb; /* Paars */
            --secondary-color: #2575fc; /* Blauw */
            --accent-color: #00c6fb; /* Lichtblauw/Cyaan */
            --background-color: #1a1a2e; /* Donkerblauw/Paars */
            --glass-bg-color: rgba(40, 40, 70, 0.5); /* Donker, semi-transparant */
            --text-color: #e0e0e0;
            --input-text-color: #ffffff;
            --input-bg-color: rgba(50, 50, 80, 0.7);
            --border-color: rgba(255, 255, 255, 0.15);
            --shadow-color: rgba(0, 0, 0, 0.3);
            --user-message-bg: #2575fc;
            --bot-message-bg: rgba(70, 70, 100, 0.8);
            --font-family: 'Roboto', 'Segoe UI', Arial, sans-serif;
            --border-radius: 12px;
            --container-max-width: 700px;
        }

        @font-face {
            font-family: 'Roboto';
            src: url('https://fonts.gstatic.com/s/roboto/v27/KFOmCnqEu92Fr1Mu4mxK.woff2') format('woff2');
            font-weight: 400;
            font-style: normal;
        }
        @font-face {
            font-family: 'Roboto';
            src: url('https://fonts.gstatic.com/s/roboto/v27/KFOlCnqEu92Fr1MmWUlvAx0.woff2') format('woff2');
            font-weight: 700;
            font-style: normal;
        }


        body {
            font-family: var(--font-family);
            margin: 0;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }

        #appHeader {
            text-align: center;
            margin-bottom: 20px;
        }

        #appHeader h1 {
            font-size: 2.8em;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 0 10px rgba(255,255,255,0.3), 0 0 20px var(--accent-color);
            margin: 0;
        }
         #appHeader p {
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.8;
        }

        #chatContainer {
            width: 100%;
            max-width: var(--container-max-width);
            background: var(--glass-bg-color);
            backdrop-filter: blur(15px) saturate(180%);
            -webkit-backdrop-filter: blur(15px) saturate(180%); /* Voor Safari */
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: 0 8px 32px 0 var(--shadow-color);
            padding: 25px;
            display: flex;
            flex-direction: column;
            height: 75vh; /* Responsive height */
            max-height: 700px; /* Max height */
        }

        #fileLoadSection {
            padding: 15px;
            margin-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            text-align: center;
        }

        .status {
            color: var(--accent-color);
            font-style: italic;
            font-size: 0.9em;
        }
        .warning {
            color: #ff4d4d;
            font-weight: bold;
        }

        #chatbox {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 15px;
            scrollbar-width: thin;
            scrollbar-color: var(--accent-color) transparent;
        }

        #chatbox::-webkit-scrollbar {
            width: 8px;
        }

        #chatbox::-webkit-scrollbar-track {
            background: transparent;
        }

        #chatbox::-webkit-scrollbar-thumb {
            background-color: var(--accent-color);
            border-radius: 10px;
            border: 2px solid transparent;
        }

        .message {
            margin-bottom: 12px;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            line-height: 1.5;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 0.95em;
        }

        .user {
            background-color: var(--user-message-bg);
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            text-align: right;
        }

        .bot {
            background-color: var(--bot-message-bg);
            color: var(--text-color);
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .bot.thinking {
            font-style: italic;
            opacity: 0.7;
        }

        #chatInputSection {
            display: flex;
            align-items: center;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        #userInput {
            flex-grow: 1;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--input-bg-color);
            color: var(--input-text-color);
            font-size: 1em;
            margin-right: 10px;
            outline: none;
        }
        #userInput::placeholder {
            color: rgba(224, 224, 224, 0.6);
        }
        #userInput:focus {
            border-color: var(--accent-color);
            box-shadow: 0 0 8px var(--accent-color);
        }

        #sendButton {
            padding: 10px;
            background-color: var(--accent-color);
            color: var(--background-color);
            border: none;
            border-radius: 50%; /* Rond */
            cursor: pointer;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.3s ease, transform 0.2s ease;
        }

        #sendButton svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }

        #sendButton:hover {
            background-color: var(--secondary-color);
            color: #fff;
            transform: scale(1.1);
        }
        #sendButton:active {
            transform: scale(0.95);
        }

        /* Initial hide for chat input */
        #chatInputSection {
            display: none;
        }
    </style>
</head>
<body>

<div id="appHeader">
    <h1>DigiBase 1.1</h1>
    <p>Uw interne virtuele assistent van Digipunt</p>
</div>

<div id="chatContainer">
    <div id="fileLoadSection">
        <p class="status" id="loadStatus">Bezig met laden van bedrijfsgegevens...</p>
        <!-- De eigenlijke file input is verborgen, data laadt van URL -->
    </div>

    <div id="chatbox"></div>

    <div id="chatInputSection">
        <input type="text" id="userInput" placeholder="Stel uw vraag aan Digipunt...">
        <button id="sendButton" onclick="sendMessage()" aria-label="Verstuur bericht">
            <svg viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
            </svg>
        </button>
    </div>
</div>

<script>
    // --- CONFIGURATIE ---
    const GEMINI_API_KEY = "AIzaSyAkeZNQdyOcf27Wo9D75ydwELGC2XeM_eU"; 
    const DATA_FILE_URL = 'data.txt'; // URL van uw databestand.

    // --- GLOBALE VARIABELEN ---
    let infoChunks = [];
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    const loadStatus = document.getElementById('loadStatus');
    const fileLoadSection = document.getElementById('fileLoadSection');
    const chatInputSection = document.getElementById('chatInputSection');

    // --- DATA LAAD LOGICA (van URL) ---
    async function loadDataFromUrl() {
        loadStatus.textContent = `Bezig met ophalen van data via ${DATA_FILE_URL}...`;

        try {
            const response = await fetch(DATA_FILE_URL);

            if (!response.ok) {
                 loadStatus.innerHTML = `<span class="warning">Fout: Kon data niet ophalen van ${DATA_FILE_URL}. Status: ${response.status}</span>`;
                 console.error("Fetch error:", response.status, response.statusText);
                 return;
            }

            const fileContent = await response.text();
            processCompanyInfo(fileContent);

            loadStatus.textContent = `Data succesvol geladen van "${DATA_FILE_URL}". De assistent is klaar!`;
            // Vertraging om de status te tonen, daarna verbergen
            setTimeout(() => {
                fileLoadSection.style.display = 'none';
                chatInputSection.style.display = 'flex'; // Gebruik flex voor de input sectie
                addMessage("Hallo! Ik ben de virtuele assistent van Digipunt. Hoe kan ik u vandaag helpen?", 'bot');
                userInput.focus();
            }, 1500);


        } catch (error) {
            loadStatus.innerHTML = `<span class="warning">Fout bij ophalen data: ${error.message}</span>`;
            console.error("Fetch error:", error);
        }
    }

    // --- DATA VERWERKING ---
    function processCompanyInfo(text) {
        infoChunks = text.replace(/\r\n/g, "\n")
                         .split(/\n\s*\n/) // Split op lege regels
                         .map(chunk => chunk.trim())
                         .filter(chunk => chunk.length > 0);
        // console.log("Verwerkte infoChunks:", JSON.stringify(infoChunks, null, 2));
    }

    // --- CHATBOT LOGICA ---
    function findRelevantChunks(query) {
        if (infoChunks.length === 0) return "";

        const queryWords = query.toLowerCase().split(/\s+/).filter(word => word.length > 2 && !["de", "het", "een", "is", "wie", "wat", "waar", "zijn", "ik", "u", "van", "voor"].includes(word));
        // console.log("[findRelevantChunks] Query:", query);
        // console.log("[findRelevantChunks] Gefilterde Query woorden:", queryWords);

        let relevantChunksWithScores = [];

        infoChunks.forEach((chunk, index) => {
            let score = 0;
            const lowerChunk = chunk.toLowerCase();
            queryWords.forEach(word => {
                if (lowerChunk.includes(word)) {
                    score++;
                }
            });
            if (score > 0) {
                relevantChunksWithScores.push({ chunk: chunk, score: score });
            }
        });

        relevantChunksWithScores.sort((a, b) => b.score - a.score);
        const topChunks = relevantChunksWithScores.slice(0, 4).map(item => item.chunk); // Iets meer context
        // console.log("[findRelevantChunks] Top Chunks geselecteerd voor context:", JSON.stringify(topChunks, null, 2));
        return topChunks.join("\n\n---\n\n");
    }

    async function sendMessage() {
        const query = userInput.value.trim();
        if (!query) return;
        if (infoChunks.length === 0) {
            addMessage("De bedrijfsdata is nog niet geladen. Een ogenblik geduld a.u.b.", 'bot');
            return;
        }

        addMessage(query, 'user');
        userInput.value = '';
        const thinkingMsgId = 'thinking-message-' + Date.now();
        addMessage("Even aan het nadenken...", 'bot', thinkingMsgId, true); // true for thinking class

        if (!GEMINI_API_KEY || GEMINI_API_KEY === "AIzaSyB04OBGNKEWmZp1WSvgAjjDzYMe9SGE_fU" || GEMINI_API_KEY.startsWith("AIzaSyB04OBGNKEWmZp1WSvgAjjDzYMe9SGE_fU")) {
            removeMessageById(thinkingMsgId);
            addMessage("FOUT: De Gemini API Key is niet correct geconfigureerd in het script. Vervang de placeholder key.", 'bot');
            return;
        }

        const context = findRelevantChunks(query);
        // console.log("Context die naar LLM wordt gestuurd:\n" + context);

        const promptText = `
Je bent een behulpzame en vriendelijke virtuele assistent voor Digipunt, een organisatie in BelgiÃ«.
Je spreekt altijd in het Nederlands (Vlaams).
Beantwoord de vraag van de gebruiker UITSLUITEND op basis van de volgende informatie.
Als de informatie niet aanwezig is in de context, geef dan duidelijk aan dat je die specifieke informatie niet hebt gevonden in de verstrekte documenten.
Speculeer niet en verzin geen antwoorden. Wees beknopt en professioneel, maar vriendelijk.
Antwoord alsof je namens Digipunt spreekt. Gebruik "wij" of "Digipunt" waar gepast.

Bedrijfsinformatie Context:
--- START VAN CONTEXT ---
${context || "Er werd geen specifieke context gevonden in de documenten voor deze vraag."}
--- EINDE VAN CONTEXT ---

Vraag van de gebruiker: ${query}

Antwoord (in het Nederlands/Vlaams):
`;
        // console.log("Volledige prompt die naar LLM wordt gestuurd:\n" + promptText);

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`, { // Updated model
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: promptText
                        }]
                    }],
                    // Optionele veiligheidsinstellingen (pas aan indien nodig)
                    // safetySettings: [
                    //     { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    //     { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    //     { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_MEDIUM_AND_ABOVE" },
                    //     { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_MEDIUM_AND_ABOVE" }
                    // ]
                })
            });

            removeMessageById(thinkingMsgId);

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Foutreactie:", errorData);
                let errorMessage = `Fout: ${response.status} - Kon geen antwoord van de API krijgen.`;
                if (errorData && errorData.error && errorData.error.message) {
                    errorMessage += ` Bericht: ${errorData.error.message}`;
                     if (errorData.error.message.toLowerCase().includes("api key not valid")) {
                        errorMessage += " Controleer of uw API-sleutel correct is en of de Gemini API is ingeschakeld.";
                    } else if (errorData.error.message.toLowerCase().includes("quota exceeded")) {
                         errorMessage += " U heeft mogelijk uw API-quotum overschreden.";
                    }
                }
                addMessage(errorMessage, 'bot');
                return;
            }

            const data = await response.json();
            // console.log("API Succesreactie:", data);

            if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason && data.candidates[0].finishReason !== "STOP" && data.candidates[0].finishReason !== "MAX_TOKENS") {
                let blockMessage = `Antwoord generatie gestopt. Reden: ${data.candidates[0].finishReason}.`;
                 if (data.candidates[0].safetyRatings) {
                    blockMessage += ` Veiligheidsbeoordelingen: ${JSON.stringify(data.candidates[0].safetyRatings)}`;
                }
                console.warn(blockMessage);
                addMessage("Ik kon geen volledig antwoord genereren. Dit kan te wijten zijn aan inhoudsbeperkingen of een probleem met de vraag.", 'bot');
                return;
            }
            
            if (data.promptFeedback && data.promptFeedback.blockReason) { // Check for prompt blocking
                console.warn("Prompt geblokkeerd:", data.promptFeedback);
                addMessage(`Uw vraag kon niet worden verwerkt. Reden: ${data.promptFeedback.blockReason}. Probeer uw vraag anders te formuleren.`, 'bot');
                return;
            }


            if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
                console.error("Onverwachte API-responsstructuur of ontbrekende inhoud:", data);
                let debugMessage = "Sorry, ik heb een onverwacht antwoord van de API ontvangen.";
                addMessage(debugMessage, 'bot');
                return;
            }

            const botReply = data.candidates[0].content.parts[0].text.trim();
            addMessage(botReply, 'bot');

        } catch (error) {
            removeMessageById(thinkingMsgId);
            console.error("Fetch/Netwerk Fout:", error);
            addMessage('Fout: Kon geen verbinding maken met de API. Controleer uw internetverbinding, API-sleutel, of dat het API-eindpunt correct is.', 'bot');
        }
    }

    // --- HULPFUNCTIES ---
    function addMessage(text, sender, id = null, isThinking = false) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender);
        if (isThinking) {
            messageDiv.classList.add('thinking');
        }
        messageDiv.textContent = text;
        if (id) {
            messageDiv.id = id;
        }
        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight; // Auto-scroll
    }

    function removeMessageById(id) {
        const msg = document.getElementById(id);
        if (msg) {
            msg.remove();
        }
    }

    // --- EVENT LISTENERS ---
    userInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter' && !e.shiftKey) { // Allow shift+enter for new line if needed, but here just enter
            e.preventDefault();
            sendMessage();
        }
    });

    // --- INITIALISATIE ---
    window.onload = () => {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE" || GEMINI_API_KEY.startsWith("AIzaSyB04OBGNKEWmZp1WSvgAjjDzYMe9SGE_fU")) {
             loadStatus.innerHTML = `Welkom! <span class="warning">Configureer a.u.b. uw Gemini API Key in het script. De huidige key is een placeholder.</span>`;
             // De loadknop is al verborgen, dus we doen hier niets extra's mee.
        } else {
             loadDataFromUrl(); // Automatisch data laden
        }
        // chatInputSection wordt zichtbaar na het laden van data
    };

</script>

</body>
</html>
