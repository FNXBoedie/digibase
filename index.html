<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DigiBase</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; color: #333; }
        #chatContainer { max-width: 600px; margin: auto; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        #fileLoadSection { margin-bottom: 15px; padding: 10px; border: 1px dashed #ccc; background-color: #f9f9f9; border-radius: 4px;}
        #chatbox { height: 300px; border: 1px solid #ccc; overflow-y: scroll; padding: 10px; margin-bottom: 10px; background-color: #e9e9e9; }
        .message { margin-bottom: 8px; padding: 8px 12px; border-radius: 5px; line-height: 1.4; }
        .user { background-color: #d1e7dd; text-align: right; margin-left: 40px; word-break: break-word; }
        .bot { background-color: #f8f9fa; text-align: left; margin-right: 40px; word-break: break-word; }
        input[type="text"] { width: calc(100% - 80px); padding: 10px; border: 1px solid #ccc; border-radius: 4px; vertical-align: top;}
        button { padding: 10px 15px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; vertical-align: top; }
        button:hover { background-color: #0056b3; }
        small { display: block; margin-top: 15px; color: #777; }
        .warning { color: red; font-weight: bold; margin-bottom: 15px; }
        .status { color: #555; font-style: italic; margin-bottom: 10px;}
        #chatInputSection { display: none; }
        #fileInput { display: none; } /* Hide the file input */
    </style>
</head>
<body>

<div id="chatContainer">
    <h2>DigiBase</h2>
    
    <div id="fileLoadSection">
        <p class="status" id="loadStatus">Loading company data...</p>
        <!-- File input is removed or hidden, data loads from URL -->
        <input type="file" id="fileInput" accept=".txt" style="display: none;">
        <button onclick="loadDataFromUrl()" id="loadButton">Load Data</button> <!-- Keep button, change function -->
    </div>

    <div id="chatbox"></div>

    <div id="chatInputSection">
        <input type="text" id="userInput" placeholder="Ask about our company...">
        <button onclick="sendMessage()">Send</button>
        <small>Example: "What are the opening hours?" or "Where is the head office?"</small>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const GEMINI_API_KEY = "AIzaSyB04OBGNKEWmZp1WSvgAjjDzYMe9SGE_fU"; // YOUR GEMINI API KEY
    const DATA_FILE_URL = 'data.txt'; // <-- *** IMPORTANT: Set this to the URL of your data file ***
                                      // If hosted on GitHub Pages in the same repo/folder as HTML,
                                      // just 'data.txt' (or whatever you name it) is usually correct.

    // --- GLOBAL VARIABLES ---
    let infoChunks = [];
    const chatbox = document.getElementById('chatbox');
    const userInput = document.getElementById('userInput');
    // Removed dataFileEl as we don't need the input element
    const loadStatus = document.getElementById('loadStatus');
    const fileLoadSection = document.getElementById('fileLoadSection');
    const chatInputSection = document.getElementById('chatInputSection');
    const loadButton = document.getElementById('loadButton');


    // --- DATA LOADING LOGIC (from URL) ---
    async function loadDataFromUrl() {
        loadStatus.textContent = `Fetching data from ${DATA_FILE_URL}...`;
        loadButton.disabled = true; // Disable button while loading

        try {
            const response = await fetch(DATA_FILE_URL);

            if (!response.ok) {
                 loadStatus.textContent = `Error: Could not fetch data from ${DATA_FILE_URL}. Status: ${response.status}`;
                 console.error("Fetch error:", response.status, response.statusText);
                 loadButton.disabled = false; // Re-enable button
                 return;
            }

            const fileContent = await response.text();
            console.log("Raw file content loaded from URL:\n", fileContent); // Log raw content
            processCompanyInfo(fileContent);

            loadStatus.textContent = `Data loaded from "${DATA_FILE_URL}". Chatbot is ready!`;
            fileLoadSection.style.display = 'none'; // Hide file load section
            chatInputSection.style.display = 'block'; // Show chat input section
            addMessage("Company data loaded. How can I help?", 'bot');

        } catch (error) {
            loadStatus.textContent = `Error fetching data: ${error.message}`;
            console.error("Fetch error:", error);
            loadButton.disabled = false; // Re-enable button
        }
    }

    // --- DATA PROCESSING (Same as before) ---
    function processCompanyInfo(text) {
        infoChunks = text.replace(/\r\n/g, "\n")
                         .split(/\n\s*\n/)
                         .map(chunk => chunk.trim())
                         .filter(chunk => chunk.length > 0);
        console.log("Processed infoChunks:", JSON.stringify(infoChunks, null, 2));
    }

    // --- CHATBOT LOGIC (Same as before) ---

    function findRelevantChunks(query) {
         if (infoChunks.length === 0) return "";

        const queryWords = query.toLowerCase().split(/\s+/).filter(word => word.length > 2 && word !== "the" && word !== "is" && word !== "who" && word !== "what" && word !== "where" && word !== "are"); // Added more common filter words
        console.log("[findRelevantChunks] Query:", query);
        console.log("[findRelevantChunks] Filtered Query words:", queryWords);

        let relevantChunksWithScores = [];

        infoChunks.forEach((chunk, index) => {
            let score = 0;
            let matchedWords = [];
            const lowerChunk = chunk.toLowerCase();
            queryWords.forEach(word => {
                if (lowerChunk.includes(word)) {
                    score++;
                    matchedWords.push(word);
                }
            });
             // Also check for exact location names if possible (more advanced retrieval)
            // For now, rely on keywords being in the chunk

            if (score > 0) {
                relevantChunksWithScores.push({ chunk: chunk, score: score, index: index, matched: matchedWords });
            }
            console.log(`[findRelevantChunks] Chunk ${index} (Score: ${score}, Matched: ${matchedWords.join(', ')}): "${chunk.substring(0, 70)}..."`);
        });

        relevantChunksWithScores.sort((a, b) => b.score - a.score);

        const topChunks = relevantChunksWithScores.slice(0, 3).map(item => item.chunk);

        console.log("[findRelevantChunks] Top Chunks selected for context:", JSON.stringify(topChunks, null, 2));
        return topChunks.join("\n\n---\n\n");
    }


    async function sendMessage() {
        const query = userInput.value.trim();
        if (!query) return;
        if (infoChunks.length === 0) {
            addMessage("Company data is not loaded yet. Please wait or try reloading.", 'bot');
            return;
        }

        addMessage(query, 'user');
        userInput.value = '';
        addMessage("Thinking...", 'bot', 'thinking-message');

        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
            removeThinkingMessage();
            addMessage("ERROR: Gemini API Key not configured correctly in the script.", 'bot');
            return;
        }

        const context = findRelevantChunks(query);
        console.log("Context being sent to LLM:\n" + context);

         if (!context && infoChunks.length > 0) {
             console.log("No relevant context found by findRelevantChunks for query:", query);
             // You could add a message here like: addMessage("Sorry, I couldn't find specific information related to that in my documents.", 'bot');
             // But the LLM prompt handles the "If information isn't present..." part
        }


        const promptText = `
You are a helpful company assistant for a small local business.
Answer the user's question based ONLY on the following information.
If the information isn't present in the context, clearly state that you don't have that specific information from the provided documents.
If the context seems irrelevant to the question, you can also state that the provided documents don't seem to contain the answer.
Be concise and friendly.

Company Information Context:
--- START OF CONTEXT ---
${context || "No specific context was found in the documents for this query."}
--- END OF CONTEXT ---

User's question: ${query}

Answer:
`;
        console.log("Full prompt being sent to LLM:\n" + promptText);

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    contents: [{
                        parts: [{
                            text: promptText
                        }]
                    }]
                     // Optional safety settings
                })
            });

            removeThinkingMessage();

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error Response:", errorData);
                let errorMessage = `Error: ${response.status} - Failed to get response from API.`;
                if (errorData && errorData.error && errorData.error.message) {
                    errorMessage += ` Message: ${errorData.error.message}`;
                     if (errorData.error.message.toLowerCase().includes("api key not valid")) {
                        errorMessage += " Please check if your API key is correct and has the Gemini API enabled.";
                    } else if (errorData.error.message.toLowerCase().includes("quota exceeded")) {
                         errorMessage += " You might have exceeded your API quota.";
                    }
                }
                addMessage(errorMessage, 'bot');
                return;
            }

            const data = await response.json();
            console.log("API Success Response:", data);

             if (data.candidates && data.candidates.length > 0 && data.candidates[0].finishReason && data.candidates[0].finishReason !== "STOP") {
                let blockMessage = `Response generation was stopped. Reason: ${data.candidates[0].finishReason}.`;
                 if (data.candidates[0].safetyRatings) {
                    blockMessage += ` Safety Ratings: ${JSON.stringify(data.candidates[0].safetyRatings)}`;
                }
                console.warn(blockMessage);
                addMessage("I couldn't generate a full response. This might be due to content restrictions or an issue with the query.", 'bot');
                return;
            }

            if (!data.candidates || !data.candidates[0].content || !data.candidates[0].content.parts || !data.candidates[0].content.parts[0].text) {
                console.error("Unexpected API response structure or missing content:", data);
                 let debugMessage = "Sorry, I received an unexpected response from the API.";
                 if (data.promptFeedback && data.promptFeedback.blockReason) {
                    debugMessage += ` Your prompt was blocked. Reason: ${data.promptFeedback.blockReason}`;
                }
                addMessage(debugMessage, 'bot');
                return;
            }


            const botReply = data.candidates[0].content.parts[0].text.trim();
            addMessage(botReply, 'bot');

        } catch (error) {
            removeThinkingMessage();
            console.error("Fetch/Network Error:", error);
            addMessage('Error: Could not connect to the API. Check your internet connection, API key, or if the API endpoint is correct.', 'bot');
        }
    }

    // --- UTILITY FUNCTIONS (Same as before) ---
    function addMessage(text, sender, id = null) {
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('message', sender);
        messageDiv.textContent = text;
        if (id) {
            messageDiv.id = id;
        }
        chatbox.appendChild(messageDiv);
        chatbox.scrollTop = chatbox.scrollHeight;
    }

     function removeThinkingMessage() {
        const thinkingMsg = document.getElementById('thinking-message');
        if (thinkingMsg) {
            thinkingMsg.remove();
        }
    }

    // --- EVENT LISTENERS ---
    userInput.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });

    // --- INITIAL SETUP ---
    window.onload = () => {
        if (!GEMINI_API_KEY || GEMINI_API_KEY === "YOUR_GEMINI_API_KEY_HERE") {
             loadStatus.innerHTML = 'Welcome! <span style="color:red; font-weight:bold;">Please configure your Gemini API Key in the HTML script.</span>';
             loadButton.disabled = true;
        } else {
             // Automatically attempt to load data when page loads
             loadDataFromUrl(); // Call the new loading function
        }
        chatInputSection.style.display = 'none'; // Ensure chat is hidden initially
         loadButton.style.display = 'none'; // Hide the load button as it loads automatically
    };

</script>

</body>
</html>
